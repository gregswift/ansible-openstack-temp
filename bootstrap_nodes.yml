- include: init_nodes.yml

- hosts: controller
  user: root
  vars_files:
  - "vars/global_vars.yml"
  tasks:
    - include: controller/tasks/packages.yml
    - include: controller/tasks/local_kvm.yml
    - include: controller/tasks/chef_server.yml
  handlers:
    - include: controller/handlers/restart_iptables.yml

- include: chefserver.yml

- hosts: openstack-nodes
  user: root
  vars_files:
  - "vars/global_vars.yml"
  tasks:
    - include: common/tasks/bootstrap_chef.yml

- hosts: controller
  user: root
  vars_files:
  - "vars/global_vars.yml"
  vars:
    - host: $chef_ip
    - roles: "'role[single-controller]','recipe[gravity-bu::default]'"
  tasks:
    - include: common/tasks/run_chef.yml

- hosts: compute
  user: root
  vars_files:
  - "vars/global_vars.yml"
  vars:
    - host: $hostvars.{${groups.controller}[0]}.ansible_eth0
    - roles: "'role[single-compute]'"
  tasks:
    - include: common/tasks/run_chef.yml
